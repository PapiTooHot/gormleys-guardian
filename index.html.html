<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gormley's Guardian: Battle for the Backyard!</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #333;
      font-family: Arial, sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    #canvasContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #333;
    }

    #gameCanvas {
      background: #222;
      max-width: 100%;
      max-height: 100%;
      width: 100%;
      height: auto;
    }

    .screen {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 800px; /* Fixed width */
      height: 450px; /* Adjusted to 16:9 ratio */
      transform: translate(-50%, -50%);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background-size: cover;
      z-index: 1000; /* Ensures it overlays everything */
      text-align: center;
      box-sizing: border-box;
    }
    .hidden {
      display: none !important;
    }

    .button {
      margin: 8px;
      padding: 12px 20px;
      background: #555;
      border: none;
      cursor: pointer;
      color: #fff;
      font-size: 16px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .button:hover {
      background: #777;
    }

    #hud {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      font-size: 18px;
      z-index: 999; /* Below screens but above canvas */
    }
    .hud-item {
      background: rgba(0,0,0,0.4);
      padding: 8px 12px;
      border-radius: 4px;
    }

    #lunaButton {
      background: none;
      border: none;
      cursor: pointer;
    }

    #lunaButton img {
      width: 40px;
      height: auto;
    }

    /* Fullscreen Button Styling */
    #fullscreenButton, #fullscreenStartButton {
      background: #555;
      border: none;
      cursor: pointer;
      color: #fff;
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    #fullscreenButton:hover, #fullscreenStartButton:hover {
      background: #777;
    }
  </style>
</head>
<body>
  <!-- Enter Screen -->
  <div id="enterScreen" class="screen">
    <h1>Welcome to Gormley's Guardian: Battle for the Backyard!</h1>
    <button id="enterButton" class="button">Enter</button>
  </div>

  <!-- Start Screen -->
  <div id="startScreen" class="screen hidden" style="background-image: url('backgroundstart.png'); background-size: cover;">
    <h1>Gormley's Guardian: Battle for the Backyard!</h1>
    <button id="startButton" class="button">Start Game</button>
    <button id="quitButton" class="button">Quit</button>
    <button id="fullscreenStartButton" class="button">Toggle Full Screen</button> <!-- New Button -->
  </div>

  <!-- Heads-Up Display (HUD) -->
  <div id="hud" class="hidden">
    <div class="hud-item">Score: <span id="scoreDisplay">0</span></div>
    <div class="hud-item">Level: <span id="levelDisplay">1</span></div>
    <div class="hud-item">Cans: <span id="cansDisplay">0</span>/<span id="cansNeeded">5</span></div>
    <button id="lunaButton" class="hidden">
      <img src="LunaHowl.png" alt="Luna Button">
    </button>
    <button id="fullscreenButton" class="button">Toggle Full Screen</button> <!-- Existing Fullscreen Button -->
  </div>

  <!-- Canvas Container -->
  <div id="canvasContainer">
    <canvas id="gameCanvas" width="800" height="450"></canvas>
  </div>

  <!-- Game Over Screen -->
  <div id="gameOverScreen" class="screen hidden" style="background-image: url('gameover.png'); background-size: cover;">
    <h2>Game Over</h2>
    <p>Your Score: <span id="finalScore"></span></p>
    <button id="restartButton" class="button">Restart</button>
    <button id="quitButton2" class="button">Quit</button>
  </div>

  <script>
    const assetSources = {
      ufoTriangle: "UFOTriangle.png",
      ufoSmall: "UFOSmall.png",
      ufoMedium: "UFOMedium.png",
      ufoLarge: "UFOLarge.png",
      ufoDroneSmall: "UFODroneSmall.png",
      ufoDroneLarge: "UFODroneLarge.png",
      mothership: "Mothership.png",
      cannedGood: "CannedGood.png",
      blaster: "Blaster.png",
      lunaHowl: "LunaHowl.png",
      gameplayBackground: "Gameplaybackground.png",
      explosionA1: "ExplosionA1.png",
      explosionA2: "ExplosionA2.png",
      explosionA3: "ExplosionA3.png",
      explosionB1: "ExplosionB1.png",
      explosionB2: "ExplosionB2.png",
      explosionB3: "ExplosionB3.png",
      gregStand: "GregGunHoldRight.png",
      music: "music.mp3",
      howlSound: "howl.mp3",
      explosionSound: "explosion.mp3",
      backgroundStart: "backgroundstart.png",
      introMusic: "intromusic.mp3",
      deathMusic: "death.mp3"
    };

    const assets = {};
    let assetsLoaded = 0;
    const totalAssets = Object.keys(assetSources).length;

    function loadAssets() {
      for (const [key, src] of Object.entries(assetSources)) {
        if (["music", "howlSound", "explosionSound", "introMusic", "deathMusic"].includes(key)) {
          assets[key] = new Audio(src);
        } else {
          assets[key] = new Image();
          assets[key].src = src;
          assets[key].onload = () => {
            assetsLoaded++;
            if (assetsLoaded === totalAssets - 5) { // Excluding audio files
              document.getElementById("enterButton").disabled = false;
            }
          };
        }
      }
    }

    loadAssets();

    const canvasContainer = document.getElementById('canvasContainer');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Define the internal resolution (16:9)
    const INTERNAL_WIDTH = 800;
    const INTERNAL_HEIGHT = 450;

    // Scale factors
    let scaleX = 1;
    let scaleY = 1;

    // Update W and H to match internal resolution
    const W = INTERNAL_WIDTH;
    const H = INTERNAL_HEIGHT;

    let gameRunning = false;
    let score = 0;
    let level = 1;
    let cansCollected = 0;
    const cansNeededForLuna = 5;
    let lunaReady = false;
    let ufos = [];
    let cannedGoods = [];
    let explosions = [];
    let spawnTimer = 0;
    let spawnInterval = 100;

    const hud = document.getElementById('hud');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const levelDisplay = document.getElementById('levelDisplay');
    const cansDisplay = document.getElementById('cansDisplay');
    const lunaButton = document.getElementById('lunaButton');
    const enterScreen = document.getElementById('enterScreen');
    const enterButton = document.getElementById('enterButton');
    const startScreen = document.getElementById('startScreen');
    const startButton = document.getElementById('startButton');
    const fullscreenStartButton = document.getElementById('fullscreenStartButton'); // New Element
    const gameOverScreen = document.getElementById('gameOverScreen');
    const finalScore = document.getElementById('finalScore');
    const restartButton = document.getElementById('restartButton');
    const quitButton2 = document.getElementById('quitButton2');
    const fullscreenButton = document.getElementById('fullscreenButton'); // Existing Element

    // Detect if the user is on a mobile device
    const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    // Define speed multiplier based on device type
    const speedMultiplier = isMobile ? 0.6 : 1; // UFOs fall 40% slower on mobile

    // Event Listeners
    enterButton.addEventListener('click', () => {
      assets.introMusic.loop = true;
      assets.introMusic.play();
      enterScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
    });

    startButton.addEventListener('click', startGame);
    lunaButton.addEventListener('click', handleLunaHowl);
    fullscreenButton.addEventListener('click', toggleFullScreen); // Existing Fullscreen Toggle
    fullscreenStartButton.addEventListener('click', toggleFullScreen); // New Fullscreen Toggle

    canvas.addEventListener('mousedown', onCanvasClick);

    // Also add touch event for mobile
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault(); // Prevent default touch actions
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const touchX = touch.clientX - rect.left;
      const touchY = touch.clientY - rect.top;
      handleInput(touchX, touchY);
    });

    restartButton.addEventListener('click', () => {
      // Stop the death music if it's playing
      assets.deathMusic.pause();
      assets.deathMusic.currentTime = 0;
      
      gameOverScreen.classList.add('hidden');
      startGame();
    });

    quitButton2.addEventListener('click', () => {
      alert("Thanks for playing!");
      location.reload();
    });

    // Listen for fullscreen change to update the button text
    document.addEventListener('fullscreenchange', updateFullscreenButton);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
    document.addEventListener('mozfullscreenchange', updateFullscreenButton);
    document.addEventListener('MSFullscreenChange', updateFullscreenButton);

    // Resize Canvas Function
    function resizeCanvas() {
      const containerWidth = canvasContainer.clientWidth;
      const containerHeight = canvasContainer.clientHeight;

      // Calculate the scaling factor to maintain 16:9
      const scale = Math.min(containerWidth / INTERNAL_WIDTH, containerHeight / INTERNAL_HEIGHT);

      // Calculate the new canvas size
      const newWidth = INTERNAL_WIDTH * scale;
      const newHeight = INTERNAL_HEIGHT * scale;

      // Set the canvas CSS width and height
      canvas.style.width = `${newWidth}px`;
      canvas.style.height = `${newHeight}px`;

      // Update scale factors
      scaleX = newWidth / INTERNAL_WIDTH;
      scaleY = newHeight / INTERNAL_HEIGHT;
    }

    // Initial resize
    resizeCanvas();

    // Resize canvas on window resize or fullscreen change
    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('fullscreenchange', resizeCanvas);
    document.addEventListener('webkitfullscreenchange', resizeCanvas);
    document.addEventListener('mozfullscreenchange', resizeCanvas);
    document.addEventListener('MSFullscreenChange', resizeCanvas);

    function startGame() {
      assets.introMusic.pause();
      startScreen.classList.add('hidden');
      hud.classList.remove('hidden');
      gameOverScreen.classList.add('hidden');
      gameRunning = true;
      score = 0;
      level = 1;
      cansCollected = 0;
      lunaReady = false;
      ufos = [];
      cannedGoods = [];
      explosions = [];
      spawnTimer = 0;
      spawnInterval = 100;
      updateHUD();
      assets.music.loop = true;
      assets.music.play();
      requestAnimationFrame(gameLoop);
    }

    function gameOver() {
      gameRunning = false;
      hud.classList.add('hidden');
      gameOverScreen.classList.remove('hidden');
      finalScore.textContent = score;
      assets.music.pause();
      assets.deathMusic.loop = true;
      assets.deathMusic.play();

      // Ensure Game Over Screen is visible in fullscreen
      // No additional action needed as the screen overlays the canvas
    }

    function gameLoop() {
      if (!gameRunning) return;

      ctx.clearRect(0, 0, W, H);
      ctx.drawImage(assets.gameplayBackground, 0, 0, W, H);

      updateUFOs();
      updateCannedGoods();
      updateExplosions();

      drawUFOs();
      drawCannedGoods();
      drawExplosions();
      drawGreg();

      spawnTimer++;
      if (spawnTimer >= spawnInterval) {
        spawnTimer = 0;
        spawnUFO();
        maybeSpawnCannedGood();
      }

      requestAnimationFrame(gameLoop);
    }

    function spawnUFO() {
      if (level >= 10 && Math.random() < 0.1) {
        ufos.push({
          x: Math.random() * (W - 100),
          y: -100,
          speed: 0.5 * speedMultiplier, // Apply speed multiplier
          health: 10,
          width: 100,
          height: 100,
          type: "mothership"
        });
      } else {
        let baseSpeed = 1 + (level * 0.2);
        let health = (Math.random() < 0.2) ? 2 + level : 1 + Math.floor(level / 2);
        let speed;

        if (health > 3) {
          // Large UFO falls 20% slower than medium
          speed = baseSpeed * 0.64 * speedMultiplier; // 0.8 * 0.8 = 0.64
        } else if (health > 1) {
          // Medium UFO falls 20% slower than small
          speed = baseSpeed * 0.8 * speedMultiplier;
        } else {
          // Small UFO falls at base speed
          speed = baseSpeed * speedMultiplier;
        }

        ufos.push({
          x: Math.random() * (W - 50),
          y: -50,
          speed: speed,
          health: health,
          width: 40,
          height: 40,
        });
      }
    }

    function updateUFOs() {
      for (let i = ufos.length - 1; i >= 0; i--) {
        let ufo = ufos[i];
        ufo.y += ufo.speed;
        if (ufo.y > H) {
          gameOver();
          return;
        }
      }
    }

    function drawUFOs() {
      ufos.forEach(ufo => {
        const sprite = ufo.type === "mothership" ? assets.mothership :
                       ufo.health > 3 ? assets.ufoLarge :
                       ufo.health > 1 ? assets.ufoMedium :
                       assets.ufoSmall;
        ctx.drawImage(sprite, ufo.x, ufo.y, ufo.width, ufo.height);
      });
    }

    function spawnExplosion(x, y, size) {
      const explosionFrames = size === "large"
        ? [assets.explosionB1, assets.explosionB2, assets.explosionB3]
        : [assets.explosionA1, assets.explosionA2, assets.explosionA3];
      explosions.push({
        x,
        y,
        frames: explosionFrames,
        currentFrame: 0,
        frameDelay: 5,
        frameTimer: 0,
      });
      assets.explosionSound.currentTime = 0;
      assets.explosionSound.play();
    }

    function updateExplosions() {
      for (let i = explosions.length - 1; i >= 0; i--) {
        const explosion = explosions[i];
        explosion.frameTimer++;
        if (explosion.frameTimer >= explosion.frameDelay) {
          explosion.frameTimer = 0;
          explosion.currentFrame++;
          if (explosion.currentFrame >= explosion.frames.length) {
            explosions.splice(i, 1);
          }
        }
      }
    }

    function drawExplosions() {
      explosions.forEach(explosion => {
        const frame = explosion.frames[explosion.currentFrame];
        ctx.drawImage(frame, explosion.x - 20, explosion.y - 20, 40, 40);
      });
    }

    function handleInput(x, y) {
      // Adjust the input coordinates based on the scale
      const adjustedX = x / scaleX;
      const adjustedY = y / scaleY;

      for (let i = ufos.length - 1; i >= 0; i--) {
        let ufo = ufos[i];
        if (adjustedX >= ufo.x && adjustedX <= ufo.x + ufo.width &&
            adjustedY >= ufo.y && adjustedY <= ufo.y + ufo.height) {
          ufo.health--;
          if (ufo.health <= 0) {
            score += ufo.type === "mothership" ? 100 :
                     ufo.width > 40 ? 50 :
                     ufo.width > 20 ? 20 : 10;
            spawnExplosion(ufo.x, ufo.y, ufo.width > 40 ? "large" : "small");
            ufos.splice(i, 1);

            if (score % 100 === 0) {
              level++;
              spawnInterval = Math.max(20, 100 - level * 5);
            }
          }
          updateHUD();
          return;
        }
      }

      for (let i = cannedGoods.length - 1; i >= 0; i--) {
        let can = cannedGoods[i];
        if (adjustedX >= can.x && adjustedX <= can.x + can.width &&
            adjustedY >= can.y && adjustedY <= can.y + can.height) {
          cansCollected++;
          if (cansCollected >= cansNeededForLuna) {
            lunaReady = true;
          }
          cannedGoods.splice(i, 1);
          updateHUD();
          return;
        }
      }
    }

    function onCanvasClick(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      handleInput(mouseX, mouseY);
    }

    function drawGreg() {
      ctx.drawImage(assets.gregStand, W / 2 - 100, H - 100, 80, 100);
    }

    function updateCannedGoods() {
      for (let i = cannedGoods.length - 1; i >= 0; i--) {
        let can = cannedGoods[i];
        can.y += can.speed;
        if (can.y > H) cannedGoods.splice(i, 1);
      }
    }

    function drawCannedGoods() {
      cannedGoods.forEach(can => {
        ctx.drawImage(assets.cannedGood, can.x, can.y, can.width, can.height);
      });
    }

    function maybeSpawnCannedGood() {
      if (Math.random() < 0.2) {
        cannedGoods.push({
          x: Math.random() * (W - 20),
          y: -20,
          speed: 1,
          width: 20,
          height: 20,
        });
      }
    }

    function handleLunaHowl() {
      if (!lunaReady) return;

      assets.howlSound.play();
      ctx.clearRect(0, 0, W, H);
      ctx.drawImage(assets.lunaHowl, 0, 0, W, H);

      setTimeout(() => {
        ufos = [];
        cansCollected = 0;
        lunaReady = false;
        updateHUD();
      }, 1000);
    }

    function updateHUD() {
      scoreDisplay.textContent = score;
      levelDisplay.textContent = level;
      cansDisplay.textContent = `${cansCollected}/${cansNeededForLuna}`;
      lunaButton.classList.toggle('hidden', !lunaReady);
    }

    // Fullscreen Functions

    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        // Enter fullscreen
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
        });
      } else {
        // Exit fullscreen
        document.exitFullscreen();
      }
    }

    function updateFullscreenButton() {
      if (document.fullscreenElement) {
        fullscreenButton.textContent = "Exit Full Screen";
        fullscreenStartButton.textContent = "Exit Full Screen";
      } else {
        fullscreenButton.textContent = "Full Screen";
        fullscreenStartButton.textContent = "Full Screen";
      }
    }
  </script>
</body>
</html>
